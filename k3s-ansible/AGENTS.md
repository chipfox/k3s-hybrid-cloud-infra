# k3s-ansible — AGENTS.md

## OVERVIEW

Ansible runner that installs the k3s-ansible collection and applies the site playbook — the bridge between Terraform VM provisioning and a running k3s cluster.

### Role in the Pipeline

`ansible-playbook playbook.yaml` is the second stage of the Proxmox deployment:

1. **Installs the k3s-ansible collection** — Pulls `k3s-io/k3s-ansible` from git via `requirement.yaml`.
2. **Bootstraps k3s** — Imports the collection's `site.yml`, which installs k3s on all server and agent nodes using the Terraform-generated `inventory.ini`.

The inventory file is **never hand-edited** — Terraform writes it with the correct IPs, roles, and SSH key path. After Ansible completes, the k3s cluster is ready and Terraform's ArgoCD Helm release (applied in the same `terraform apply`) takes over to deploy all workloads via GitOps.

## STRUCTURE

```
k3s-ansible/
├── playbook.yaml
├── ansible.cfg
├── requirement.yaml
├── group_vars/all.yaml
└── inventory.ini
```

## WHERE TO LOOK

| Task | Location | Notes |
|------|----------|-------|
| Collection install + entry play | playbook.yaml | Runs ansible-galaxy + imports site.yml |
| Collection source | requirement.yaml | k3s-io/k3s-ansible (git) |
| k3s settings | group_vars/all.yaml | Version/token/user settings |
| Inventory | inventory.ini | Generated by Terraform (proxmox) |
| SSH defaults | ansible.cfg | Key path + user |

## CODE STYLE

- **Self-documenting**: `playbook.yaml` is two plays and reads top-to-bottom in 15 seconds. Keep it that way.
- **Minimal**: This directory is a thin runner over the upstream `k3s-io/k3s-ansible` collection. Do not fork or duplicate collection logic here.
- **Secrets**: SSH key path set in `ansible.cfg` (key generated by Terraform, git-ignored). k3s token in `group_vars/all.yaml` — treat as sensitive, never commit plaintext tokens.

## CONVENTIONS

- Inventory is generated by Terraform; keep paths aligned with `terraform/proxmox`.
- SSH key path in ansible.cfg points to `../terraform/proxmox/keys/id_ed25519`.

## ANTI-PATTERNS

- Do not hand-edit `inventory.ini` (regenerated by Terraform).

## COMMANDS

```bash
ansible-playbook playbook.yaml
```
