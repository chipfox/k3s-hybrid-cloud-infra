# k3s Ansible Deployment

Ansible playbooks for deploying k3s cluster on Proxmox VMs.

> **⚠️ DEPRECATION NOTICE**: ArgoCD management via Ansible (`argocd.yaml`, `argocd-app.yaml`) is now deprecated. 
> ArgoCD is now managed via **Terraform GitOps Bridge**. 
> See [GITOPS-MIGRATION.md](../GITOPS-MIGRATION.md) for migration steps and [DEPLOYMENT-GITOPS.md](../DEPLOYMENT-GITOPS.md) for the new workflow.

## What Changed?

- **k3s Installation**: Still managed via Ansible (`playbook.yaml`).
- **ArgoCD Installation**: Moved to Terraform (GitOps Bridge).
- **Application Management**: Moved to Terraform (GitOps Bridge).
- **Hybrid Cloud**: Unified management for both Proxmox k3s and AWS EKS clusters.

## Structure

- `playbook.yaml` - Main k3s installation playbook (uses k3s.orchestration collection)
- `argocd.yaml` - [DEPRECATED] Argo CD installation and configuration
- `argocd-app.yaml` - [DEPRECATED] Configure Argo CD to sync from argo-apps repository
- `requirement.yaml` - Ansible collection requirements
- `ansible.cfg` - Ansible configuration
- `inventory.ini` - Auto-generated by Terraform (do not edit manually)
- `group_vars/all.yaml` - k3s cluster configuration

## Prerequisites

- Ubuntu VMs created via Terraform (see `../terraform/proxmox/`)
- Ansible installed on control machine (WSL Ubuntu)
- SSH keys configured (`~/.ssh/id_ed25519`)
- Python bcrypt library for Argo CD password hashing: `pip3 install bcrypt`

## Deployment Steps

### 1. Install k3s Cluster

```bash
cd ~/k3s-ansible  # WSL path
ansible-playbook playbook.yaml
```

This will:
- Install k3s v1.28.5 on all nodes
- Configure 3 server nodes with embedded etcd (HA control plane)
- Join 4 agent nodes to the cluster
- Setup kubeconfig on all server nodes

### 2. Verify Cluster

```bash
ssh chipfox@10.0.0.230
sudo kubectl get nodes
```

Expected: All 7 nodes in Ready state

### 3. Install Argo CD

```bash
cd ~/k3s-ansible  # WSL path
ansible-playbook argocd.yaml -e vm_user=chipfox -e vm_password=<your_password>
```

This will:
- Create argocd namespace
- Install Argo CD v2.13.2
- Configure admin credentials (username: chipfox, password: from vm_password)
- Wait for all pods to be ready

### 4. Configure Argo CD Application

```bash
cd ~/k3s-ansible  # WSL path
ansible-playbook argocd-app.yaml
```

This will:
- Create Argo CD Application pointing to https://github.com/chipfox/argo-apps.git
- Enable auto-sync with prune and self-heal
- Wait for initial sync to complete

## Accessing Argo CD

### Via Port Forward (from k3s node)

```bash
ssh chipfox@10.0.0.230
sudo kubectl port-forward svc/argocd-server -n argocd 8080:443
```

Then visit: `https://localhost:8080`

### Via Local Port Forward (from Windows/WSL)

```bash
ssh -L 8080:10.43.184.66:443 chipfox@10.0.0.230
```

Then visit: `https://localhost:8080`

**Login:**
- Username: `chipfox` (same as vm_user)
- Password: (same as vm_password from Terraform variables)

## Cluster Configuration

### k3s Settings (group_vars/all.yaml)

- **Version**: v1.28.5+k3s1
- **Token**: 97A6ABCFF7506835173C0D7422FBB27230E96644CA9A1A740FD9C4F9EC1CEB76
- **API Endpoint**: 10.0.0.230 (k3st-1)
- **TLS SAN**: 10.0.0.230
- **Datastore**: Embedded etcd (HA)

### Nodes

**Servers (Control Plane + etcd):**
- k3st-1: 10.0.0.230 (VM 200) on pve-antec
- k3st-2: 10.0.0.231 (VM 201) on sm2
- k3st-3: 10.0.0.232 (VM 202) on supermicro

**Agents (Workers):**
- k3st-a1: 10.0.0.240 (VM 300) on pve-antec
- k3st-a2: 10.0.0.241 (VM 301) on sm2
- k3st-a3: 10.0.0.242 (VM 302) on supermicro
- k3st-a4: 10.0.0.243 (VM 303) on pve

## Argo CD Configuration

- **Namespace**: argocd
- **Version**: v2.13.2
- **Admin User**: chipfox
- **Repository**: https://github.com/chipfox/argo-apps.git (submodule at `../argo-apps/`)
- **Sync Policy**: Automated (prune + self-heal enabled)

## Troubleshooting

### Ansible can't read ansible.cfg

If running from `/mnt/e/...` (Windows drive), Ansible ignores world-writable directories. Copy files to WSL home:

```bash
cp -r /mnt/e/dev/k3s-hybrid-cloud-infra/k3s-ansible ~/k3s-ansible
cd ~/k3s-ansible
ansible-playbook playbook.yaml
```

### SSH key permission errors

Ensure SSH key has correct permissions in WSL:

```bash
chmod 600 ~/.ssh/id_ed25519
chmod 644 ~/.ssh/id_ed25519.pub
```

### Known hosts errors after VM recreation

Clear known_hosts when VMs are destroyed and recreated:

```bash
rm -f ~/.ssh/known_hosts
# Or use ansible_ssh_common_args with UserKnownHostsFile=/dev/null
```

### Kubeconfig permission denied

k3s kubeconfig requires sudo access:

```bash
sudo kubectl get nodes
# Or copy to user directory:
sudo cp /etc/rancher/k3s/k3s.yaml ~/.kube/config
sudo chown $USER:$USER ~/.kube/config
```

## References

- k3s-ansible collection: https://github.com/k3s-io/k3s-ansible
- k3s documentation: https://docs.k3s.io/
- Argo CD documentation: https://argo-cd.readthedocs.io/
- argo-apps repository: https://github.com/chipfox/argo-apps
